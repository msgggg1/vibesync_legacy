<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vibesync.follow.mapper.FollowMapper">

<!-- 팔로우 : 팔로우 데이터 추가 -->
<!-- public int insertFollow(FollowVO follow); -->
	<insert id="insertFollow">
		<selectKey keyProperty="followsIdx" resultType="int" order="BEFORE">
			SELECT follows_seq.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO follows (
			follows_idx, ac_follow, ac_following
		)
		VALUES (
			#{followsIdx}, #{acFollow}, #{acFollowing}
		)
	</insert>
<!-- // -->
    
<!-- 언팔로우 : 팔로우 데이터 삭제 -->
<!-- public int deleteFollow(FollowVO follow); -->
	<delete id="deleteFollow">
		DELETE FROM follows
		WHERE ac_follow = #{acFollow} AND ac_following = #{acFollowing}
	</delete>
<!-- // -->
    
<!-- 팔로우 관계 확인 -->
<!-- public int checkFollowStatus(FollowVO follow); -->
	<select id="checkFollowStatus" resultType="int">
		SELECT
			COUNT(follows_idx)
		FROM
			follows
		WHERE
			ac_follow = #{acFollow} AND ac_following = #{acFollowing}
	</select>
<!-- // -->

<!-- 팔로잉 수 조회 -->
<!-- public int selectFollowingCount(int acFollow); -->
	<select id="selectFollowingCount" resultType="int">
		SELECT
			COUNT(follows_idx)
		FROM
			follows
		WHERE
			ac_follow = #{acFollow}
	</select>
<!-- // -->

<!-- 팔로워 수 조회 -->
<!-- public int selectFollowerCount(int acFollowing); -->
	<select id="selectFollowerCount" resultType="int">
		SELECT
			COUNT(follows_idx)
		FROM
			follows
		WHERE
			acFollowing = #{acFollowing}
	</select>
<!-- // -->
    
<!-- 팔로잉 목록 : 유저가 팔로우하고 있는 사용자 ID 목록 조회 -->
<!-- public List<Integer> userFollowingIdList(int acIdx); -->
	<select id="userFollowingIdList" resultType="int">
		SELECT
			ac_following
		FROM
			follows
		WHERE
			ac_follow = #{acIdx}
	</select>
<!-- // -->

<!-- 팔로잉 목록 : 유저가 팔로우하고 있는 사용자 상세 정보 목록 조회 -->
<!-- public List<FollowUserDTO> getFollowingList(int acIdx); -->
	<select id="getFollowingList" resultType="com.vibesync.follow.domain.FollowUserDTO">
		SELECT 
			ac_idx as acIdx, 
			nickname, 
			img as profile_img, 
			1 as followedByCurrentUser
		FROM follows f 
		JOIN userAccount u ON u.ac_idx = f.ac_following 
		WHERE ac_follow = #{acIdx}
	</select>
<!-- // -->

<!-- 팔로워 목록 : 유저를 팔로우하고 있는 사용자 상세 정보 목록 조회 -->
<!-- public List<FollowUserDTO> getFollowerList(int acIdx); -->
	<select id="getFollowerList" resultType="com.vibesync.follow.domain.FollowUserDTO">
		SELECT 
			u.ac_idx as acIdx, 
			u.nickname, 
			u.img as profile_img,
			CASE 
				WHEN f_reverse.ac_following IS NOT NULL THEN 1 
				ELSE 0 
			END AS followedByCurrentUser
		FROM follows f 
		JOIN userAccount u ON u.ac_idx = f.ac_follow 
		LEFT JOIN follows f_reverse ON f_reverse.ac_follow = f.ac_following 
								   AND f_reverse.ac_following = f.ac_follow 
		WHERE f.ac_following = #{acIdx}
	</select>
<!-- // -->

<!-- 팔로잉 카운트 : 유저가 팔로우하고 있는 사용자 수 조회 -->
<!-- public int getFollowingCount(int acIdx); -->
	<select id="getFollowingCount" resultType="int">
		SELECT COUNT(*)
		FROM follows
		WHERE ac_follow = #{acIdx}
	</select>
<!-- // -->

<!-- 팔로워 카운트 : 유저를 팔로우하고 있는 사용자 수 조회 -->
<!-- public int getFollowerCount(int acIdx); -->
	<select id="getFollowerCount" resultType="int">
		SELECT COUNT(*)
		FROM follows
		WHERE ac_following = #{acIdx}
	</select>
<!-- // -->
    
 </mapper>