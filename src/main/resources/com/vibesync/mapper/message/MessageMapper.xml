<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vibesync.message.mapper.MessageMapper">

    <!-- 안읽은 메시지 목록 조회 -->
    <select id="selectUnreadMessageList" resultType="com.vibesync.message.domain.MessageListDTO">
        SELECT 
            m.msg_idx as "latestMessage.msgIdx",
            m.text as "latestMessage.text",
            m.time as "latestMessage.time",
            m.ac_sender as acSender,
            u.nickname as "latestMessage.senderNickname",
            u.img as "latestMessage.senderImg",
            unreadCnt as numOfUnreadMessages
        FROM message m
        JOIN (
            SELECT ac_sender, MAX(time) AS latest_time, COUNT(msg_idx) AS unreadCnt
            FROM message
            WHERE ac_receiver = #{acIdx} AND chk = 1
            GROUP BY ac_sender
        ) latest_msg
        ON m.ac_sender = latest_msg.ac_sender AND m.time = latest_msg.latest_time
        JOIN userAccount u
        ON m.ac_sender = u.ac_idx
        ORDER BY m.time DESC
    </select>
    
    <!-- 메시지 읽음 처리 -->
    <update id="updateChkMessage">
        UPDATE message 
        SET chk = 0 
        WHERE msg_idx IN
        <foreach collection="msgIdxList" item="msgIdx" open="(" separator="," close=")">
            #{msgIdx}
        </foreach>
        AND chk = 1 AND ac_receiver = #{myIdx}
    </update>
    
    <!-- 전체 메시지 목록 조회 -->
    <select id="selectMessageListAll" resultType="com.vibesync.message.domain.MessageListDTO">
        SELECT 
            m.msg_idx as "latestMessage.msgIdx",
            m.text as "latestMessage.text",
            m.time as "latestMessage.time",
            m.ac_sender as acSender,
            u.nickname as "latestMessage.senderNickname",
            u.img as "latestMessage.senderImg",
            unreadCnt as numOfUnreadMessages
        FROM message m
        JOIN (
            SELECT ac_sender, MAX(time) AS latest_time, COUNT(CASE WHEN chk = 1 THEN 1 END) AS unreadCnt
            FROM message
            WHERE ac_receiver = #{acIdx}
            GROUP BY ac_sender
        ) latest_msg
        ON m.ac_sender = latest_msg.ac_sender AND m.time = latest_msg.latest_time
        JOIN userAccount u
        ON m.ac_sender = u.ac_idx
        ORDER BY m.time DESC
    </select>
    
    <!-- 채팅방 채팅 내역 열람 -->
    <select id="selectChatHistory" resultType="com.vibesync.message.domain.MessageDTO">
        SELECT 
            msg_idx as msgIdx,
            text,
            time,
            ac_sender as acSender,
            u.nickname as senderNickname,
            u.img as senderImg
        FROM message m
        JOIN userAccount u ON m.ac_sender = u.ac_idx
        WHERE (m.ac_sender = #{myIdx} AND m.ac_receiver = #{otherIdx})
           OR (m.ac_sender = #{otherIdx} AND m.ac_receiver = #{myIdx})
        ORDER BY m.time ASC
    </select>
    
    <!-- 메시지 전송 -->
    <insert id="insertMessage">
        INSERT INTO message (msg_idx, text, time, chk, ac_receiver, ac_sender)
        VALUES (message_seq.nextval, #{text}, SYSTIMESTAMP, 1, #{receiverIdx}, #{senderIdx})
    </insert>

</mapper> 