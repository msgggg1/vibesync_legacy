<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vibesync.board.mapper.NoteMapper">

<!-- 재사용 가능한 SQL 조각 정의 -->
<sql id="criteria">
	<trim prefix="(" suffix=") AND" prefixOverrides="OR">
	   <foreach collection="typeArr" item="type">
	     <trim prefix="OR">
	        <choose>
	           <when test="type=='T'.toString()">REGEXP_LIKE( title , #{ keyword }, 'i') </when>
	           <when test="type=='C'.toString()">REGEXP_LIKE( text , #{ keyword }, 'i') </when>
	           <when test="type=='W'.toString()">REGEXP_LIKE( author , #{ keyword }, 'i') </when>
	        </choose>
	     </trim>
	   </foreach>
	</trim>
</sql>

<!-- 전체 게시글 목록 조회 (페이징 처리 X) -->
<!-- public List<NoteVO> selectAll(); -->
	<select id="selectAll" resultType="NoteVO">
		<![CDATA[
		SELECT
			n.note_idx, n.title, ua.nickname AS author
		FROM
			note n
		JOIN
			userPage up
			ON n.userPg_idx = up.userPg_idx
		JOIN
			userAccount ua
			ON up.ac_idx = ua.ac_idx
		WHERE
			n.note_idx > 0
		ORDER BY
			note_idx DESC
		]]>
	</select>
<!-- // -->		

<!-- 전체 게시글 목록 조회 (페이징 처리 O) -->
<!-- public List<NoteVO> selectWithPaging(Criteria criteria); -->
	<select id="selectWithPaging" resultType="NoteVO">
	    <![CDATA[
	    SELECT
	        note_idx, title, author
	    FROM (
	        SELECT /*+ INDEX_DESC(note pk_note) */
	            rownum rn, note_idx, title, author
	        FROM (
	            SELECT
	                n.note_idx, n.title, ua.nickname AS author
	            FROM
	                note n
	            JOIN
	                userPage up ON n.userPg_idx = up.userPg_idx
	            JOIN
	                userAccount ua ON up.ac_idx = ua.ac_idx
	            ORDER BY
	                n.note_idx DESC
	            )
	        WHERE
		]]>
		<include refid="criteria"></include>
		<![CDATA[
	            rownum <= #{pageNum} * #{amount}
	        )
	    WHERE
	        rn > (#{pageNum} - 1) * #{amount}
	    ]]>
	</select>
<!-- // -->

<!-- 총 게시글 수 조회 -->
<!-- int selectTotalCount(Criteria criteria); -->
	<select id="selectTotalCount" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			FROM note
			WHERE
		]]>
		<include refid="criteria"></include>
		<![CDATA[
			 note_idx > 0
		]]>
	</select>
<!-- // -->
	
	<!-- public List<UserSummaryVO> getNoteIdxListByUser(int ac_idx); -->	
	<select id="getNoteIdxListByUser" resultType="int" parameterType="int">
        <![CDATA[
            SELECT note_idx
            FROM note n
            JOIN userPage u ON u.userPg_idx = n.userPg_idx
            WHERE u.ac_idx = #{acIdx}
        ]]>
    </select>
    
	<!-- public int getViewCountsForNotesAllByUser(int ac_idx); -->
    <select id="getViewCountsForNotesAllByUser" resultType="int" parameterType="int">
        <![CDATA[
            SELECT NVL(SUM(view_count),0) AS viewCnt
            FROM note n
            JOIN userPage u ON u.userPg_idx = n.userPg_idx
            WHERE u.ac_idx = #{acIdx}
        ]]>
    </select>

</mapper>